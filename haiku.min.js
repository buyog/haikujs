define([],function(){"use strict";function e(e,t,r){return e.indexOf("%self")>-1&&t&&(e=e.replace(/%self/g,t.toString())),e.replace(/\$([^$]*);/g,function(e,n){var a=t[n];i(a)&&(a=r);var l=typeof a;return"string"===l||"number"===l?a:"("+l+")"})}function t(e,t){for(var r in t)t.hasOwnProperty(r)&&void 0!==t[r]&&(e[r]=t[r]);return e}function r(e,t){if(!e)return new Error("setNodeValue :: No node specified.");switch(e.tagName){case"INPUT":case"TEXTAREA":case"SELECT":"checkbox"===e.type?e.checked=t:e.value=t;break;default:e.textContent=t}}function n(e){var t=e.replace(/\+/gi,"__PLUS__");return t=t.replace(/\{/gi,"__OPENBRACE__"),t=t.replace(/\}/gi,"__CLOSEBRACE__"),t.replace(/\]/gi,"__CLOSEBRACKET__")}function a(e){var t=e.replace(/__PLUS__/gi,"+");return t=t.replace(/__OPENBRACE__/gi,"{"),t=t.replace(/__CLOSEBRACE__/gi,"}"),t.replace(/__CLOSEBRACKET__/gi,"]")}function i(e){return null===e||void 0===e}function l(e,t){var r=null;if(i(e))return null;if(e.__SANITIZED)return e;if(Array.isArray(e)){r=[];for(var a=0;a<e.length;a++)r[a]=l(e[a],t)}else switch(typeof e){case"string":r=n(c(e));break;case"object":r={__SANITIZED:!0},t>0?Object.keys(e).forEach(function(n){r[n]=l(e[n],t-1)}):r.__NORECURSE=!0;break;default:r=e}return r}function c(e){var t;do t=e,e=e.replace(P,"");while(e!==t);return e.replace(/</g,"&lt;")}function o(e,t){if(!e||!t)return null;var r="span{"+e.replace(/%/g,"$")+"}",n=s(r,t);return n?n.textContent:null}function u(e){var t,r,n,i,l=E.exec(e),c=l?document.createElement(l[0]):null;if(c){if(w.test(e)&&(r=w.exec(e),n=a(r[0].slice(1,-1)),c.appendChild(document.createTextNode(n))),N.test(e))for(r=N.exec(e),n=a(r[0].slice(1,-1)),e=e.slice(0,r.index)+e.slice(r.index+r[0].length),r=n.split(","),t=0;t<r.length;t++)i=r[t].split("="),2==i.length?c.setAttribute(i[0],i[1]):i.length>2&&c.setAttribute(i[0],i.slice(1).join("="));for(C.test(e)&&(r=C.exec(e),c.id=r[0].slice(1)),r=x.exec(e);r&&r.length;){for(t=0;t<r.length;t++)c.classList.add(r[t].slice(1));r=x.exec(e)}}else w.test(e)&&(r=w.exec(e),n=a(r[0].slice(1,-1)),c=document.createTextNode(n));return c}function d(t,r,n){var a,i,c=n?document.createElement("div"):document.createDocumentFragment(),o=c,d=null,s=e(t,l(r,1),""),f=s.split(y);for(a=0;a<f.length;a++)if(d=u(f[a].trim()),d&&o.appendChild(d),i=y.exec(s),i&&i.length)switch(i[0]){case"<":o=o.parentNode;break;case">":o=d;break;case"+":break;default:console.warn("unrecognized position delimiter:",i)}return n?c.innerHTML:c}function s(e,t){var r=d(e,t);return r&&r.childNodes.length?r.childNodes[0]:null}function f(e,t){if(e&&t){if(S.hasOwnProperty(e))throw new Error("Template '"+e+"' already exists.");S[e]=t}}function p(e){var t=S[e];return t||console.warn("Haiku: Cannot find named template '"+e+"'"),t||null}function g(e,t){var r,n=T[e];return n&&t?(t&&n.fieldName&&(r=t[n.fieldName]),r.toString()&&n.valueMap.hasOwnProperty(r)?p(n.valueMap[r]):p(n.defaultTemplate)||null):null}function h(e){var t={};return e&&e.split("|").forEach(function(e){var r=e.split(":");t[r[0]]=r[1]}),t}function _(e,r){var n=null;return e?(r&&(n="object"==typeof r?t(e||{},r):r),n):r}function b(e,t){var r,n,a,i,l,c,o=e.getAttribute("data-children-binding");if(e.hasAttribute("data-template-context")&&(l=h(e.getAttribute("data-template-context"),t)),e.innerHTML="",e.hasAttribute("data-children-prelude")&&(n=p(e.getAttribute("data-children-prelude")),n&&(c=_(l,t),i=s(n,c),e.appendChild(i),A(i,c))),o&&t.hasOwnProperty(o)&&(a=t[o],a&&void 0!==a.length))if(e.hasAttribute("data-template")){if(n=p(e.getAttribute("data-template")))for(r=0;r<a.length;r++)c=_(l,a[r]),i=s(n,c),e.appendChild(i),A(i,c)}else if(e.hasAttribute("data-template-map")){var u=e.getAttribute("data-template-map");for(r=0;r<a.length;r++)c=_(l,a[r]),n=g(u,c),n&&(i=s(n,c),e.appendChild(i),A(i,c))}e.hasAttribute("data-children-footer")&&(n=p(e.getAttribute("data-children-footer")),n&&(c=_(l,t),i=s(n,c),e.appendChild(i),A(i,c)))}function v(e,t){var n,a,i=e.getAttribute("data-binding");"%self"===i?e.hasAttribute("data-value-string")?(a=e.getAttribute("data-value-string"),r(e,o(a,t))):"object"!=typeof t&&r(e,t):i&&t.hasOwnProperty(i)&&(n=t[i],void 0!==n&&r(e,n))}function A(e,t){var r;e&&t&&(r=e.querySelectorAll("[data-children-binding]"),Array.prototype.forEach.call(r,function(e){b(e,t)}),r=e.querySelectorAll("[data-binding]"),Array.prototype.forEach.call(r,function(e){v(e,t)}))}function m(e,t){T.hasOwnProperty(e)||(T[e]=t)}var E=/^[a-z]+[1-6]?/i,y=/[><\+]/g,C=/#[_a-z]+[_a-z0-9-]*/i,x=/\.-?[_a-z]+[_a-z0-9-]*/gi,w=/{[^}]+}/,N=/\[[^\]]*\]/,S={},T={},O="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",P=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+O+">[\\s\\S]*?</script\\s*|style\\b"+O+">[\\s\\S]*?</style\\s*|/?[a-z]"+O+")>","gi");return{expand:d,create:s,bind:A,addTemplate:f,getTemplate:p,addConditionalsMap:m}});