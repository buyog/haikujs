define([],function(){"use strict";function i(a,b,c){return a.indexOf("%self")>-1&&b&&(a=a.replace(/%self/g,b.toString())),a.replace(/\$([^$]*);/g,function(a,d){var e=b[d]||c,f=typeof e;return"string"===f||"number"===f?e:"("+f+")"})}function j(a,b){if(!a)return new Error("setNodeValue :: No node specified.");switch(a.tagName){case"INPUT":case"TEXTAREA":case"SELECT":"checkbox"===a.type?a.checked=b:a.value=b;break;default:a.textContent=b}}function k(a){var b=a.replace(/\+/gi,"__PLUS__");return b=b.replace(/\{/gi,"__OPENBRACE__"),b=b.replace(/\}/gi,"__CLOSEBRACE__"),b.replace(/\]/gi,"__CLOSEBRACKET__")}function l(a){var b=a.replace(/__PLUS__/gi,"+");return b=b.replace(/__OPENBRACE__/gi,"{"),b=b.replace(/__CLOSEBRACE__/gi,"}"),b.replace(/__CLOSEBRACKET__/gi,"]")}function m(a,b){var c=null;if(!a)return null;if(a.__SANITIZED)return a;if(Array.isArray(a)){c=[];for(var d=0;d<a.length;d++)c[d]=m(a[d],b)}else switch(typeof a){case"string":c=k(a);break;case"object":c={__SANITIZED:!0},b>0?Object.keys(a).forEach(function(d){c[d]=m(a[d],b-1)}):c.__NORECURSE=!0;break;default:c=a}return c}function n(a,b){if(!a||!b)return null;var c="span{"+a.replace(/%/g,"$")+"}",d=q(c,b);return d?d.textContent:null}function o(b){var h,i,j,k,g=a.exec(b),m=g?document.createElement(g[0]):null;if(m){if(e.test(b)&&(i=e.exec(b),j=l(i[0].slice(1,-1)),m.appendChild(document.createTextNode(j))),f.test(b))for(i=f.exec(b),j=l(i[0].slice(1,-1)),b=b.slice(0,i.index)+b.slice(i.index+i[0].length),i=j.split(","),h=0;h<i.length;h++)k=i[h].split("="),2==k.length?m.setAttribute(k[0],k[1]):k.length>2&&m.setAttribute(k[0],k.slice(1).join("="));for(c.test(b)&&(i=c.exec(b),m.id=i[0].slice(1)),i=d.exec(b);i&&i.length;){for(h=0;h<i.length;h++)m.classList.add(i[h].slice(1));i=d.exec(b)}}else e.test(b)&&(i=e.exec(b),j=l(i[0].slice(1,-1)),m=document.createTextNode(j));return m}function p(a,c,d){var j,k,e=d?document.createElement("div"):document.createDocumentFragment(),f=e,g=null,h=i(a,m(c,1),""),l=h.split(b);for(j=0;j<l.length;j++)if(g=o(l[j].trim()),g&&f.appendChild(g),k=b.exec(h),k&&k.length)switch(k[0]){case"<":f=f.parentNode;break;case">":f=g;break;case"+":break;default:console.warn("unrecognized position delimiter:",k)}return d?e.innerHTML:e}function q(a,b){var c=p(a,b);return c&&c.childNodes.length?c.childNodes[0]:null}function r(a,b){if(a&&b){if(g.hasOwnProperty(a))throw new Error("Template '"+a+"' already exists.");g[a]=b}}function s(a){return g[a]||null}function t(a,b){var d,c=h[a];return c&&b?(b&&c.fieldName&&(d=b[c.fieldName]),d.toString()&&c.valueMap.hasOwnProperty(d)?s(c.valueMap[d]):s(c.defaultTemplate)||null):null}function u(a,b){var d,e,f,g,c=a.getAttribute("data-children-binding");if(c&&b.hasOwnProperty(c)&&(f=b[c],f&&void 0!==f.length))if(a.hasAttribute("data-template")){if(e=s(a.getAttribute("data-template")))for(a.innerHTML="",d=0;d<f.length;d++)g=q(e,f[d]),a.appendChild(g),w(g,f[d])}else if(a.hasAttribute("data-template-map")){var h=a.getAttribute("data-template-map");for(d=0;d<f.length;d++)e=t(h,f[d]),e&&(g=q(e,f[d]),a.appendChild(g),w(g,f[d]))}a.hasAttribute("data-children-footer")&&(e=s(a.getAttribute("data-children-footer")),e&&a.appendChild(q(e,b)))}function v(a,b){var d,e,c=a.getAttribute("data-binding");"%self"===c?a.hasAttribute("data-value-string")?(e=a.getAttribute("data-value-string"),j(a,n(e,b))):"object"!=typeof b&&j(a,b):c&&b.hasOwnProperty(c)&&(d=b[c],void 0!==d&&j(a,d))}function w(a,b){var c;a&&b&&(c=a.querySelectorAll("[data-children-binding]"),Array.prototype.forEach.call(c,function(a){u(a,b)}),c=a.querySelectorAll("[data-binding]"),Array.prototype.forEach.call(c,function(a){v(a,b)}))}function x(a,b){h.hasOwnProperty(a)||(h[a]=b)}var a=/^[a-z]+[1-6]?/i,b=/[><\+]/g,c=/#[_a-z]+[_a-z0-9-]*/i,d=/\.-?[_a-z]+[_a-z0-9-]*/gi,e=/{[^}]+}/,f=/\[[^\]]*\]/,g={},h={};return{expand:p,create:q,bind:w,addTemplate:r,getTemplate:s,addConditionalsMap:x}});